import{_ as n}from"./plugin-vue_export-helper-c27b6911.js";import{o as s,c as a,f as t}from"./app-49149863.js";const p={},o=t(`<h1 id="how-to-using-gcp-to-warp-a-geotif" tabindex="-1"><a class="header-anchor" href="#how-to-using-gcp-to-warp-a-geotif" aria-hidden="true">#</a> How to using gcp to warp a geotif</h1><p>Normally, the gcps will be used to warp a file, there are two steps to process.</p><ul><li>Step1: Finding the gcps, and using gdal_translate to add them to file</li><li>Step2: Using gdalwarp to warp the geo file</li></ul><h2 id="how-to-sample" tabindex="-1"><a class="header-anchor" href="#how-to-sample" aria-hidden="true">#</a> How to sample</h2><p>Normally to sample 10 points from the inner content of data.</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code>    <span class="token comment"># get the sample offset</span>
    x_offset <span class="token operator">=</span> dataset<span class="token punctuation">.</span>RasterXSize <span class="token operator">/</span> <span class="token punctuation">(</span>xpt_count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
    y_offset <span class="token operator">=</span> dataset<span class="token punctuation">.</span>RasterYSize <span class="token operator">/</span> <span class="token punctuation">(</span>ypt_count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
    
    <span class="token comment"># construct the req structure</span>
    idx <span class="token operator">=</span> <span class="token number">1</span>
    pts <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;algorithm&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;m2&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;msg&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;pts&quot;</span><span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> xpt_count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> y <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> ypt_count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            idx <span class="token operator">+=</span> <span class="token number">1</span>
            pts<span class="token punctuation">[</span><span class="token string">&quot;pts&quot;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{</span>
                <span class="token string">&quot;id&quot;</span>  <span class="token punctuation">:</span> idx<span class="token punctuation">,</span>
                <span class="token string">&quot;xpx&quot;</span> <span class="token punctuation">:</span> x_offset <span class="token operator">*</span> x<span class="token punctuation">,</span>
                <span class="token string">&quot;ypx&quot;</span> <span class="token punctuation">:</span> y_offset <span class="token operator">*</span> y<span class="token punctuation">,</span>
                <span class="token string">&quot;orgx&quot;</span><span class="token punctuation">:</span> geotransform<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token operator">+</span> geotransform<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> x_offset <span class="token operator">*</span> x<span class="token punctuation">,</span>
                <span class="token string">&quot;orgy&quot;</span><span class="token punctuation">:</span> geotransform<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>  <span class="token operator">+</span> geotransform<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">*</span> y_offset <span class="token operator">*</span> y<span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="how-to-add-gcps-to-file" tabindex="-1"><a class="header-anchor" href="#how-to-add-gcps-to-file" aria-hidden="true">#</a> How to add gcps to file</h2><p>Use the gdal tool gdal_translate to add all gcps to geotif.</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code>    gdaltranslate_cmdline <span class="token operator">=</span> <span class="token string">&#39;gdal_translate -of GTiff&#39;</span>
    <span class="token keyword">if</span> ret<span class="token punctuation">[</span><span class="token string">&#39;ret&#39;</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> pt <span class="token keyword">in</span> ret<span class="token punctuation">[</span><span class="token string">&#39;pts&#39;</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            gdaltranslate_cmdline <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f&#39;</span><span class="token interpolation"><span class="token punctuation">{</span>gdaltranslate_cmdline<span class="token punctuation">}</span></span><span class="token string"> -gcp </span><span class="token interpolation"><span class="token punctuation">{</span>pt<span class="token punctuation">[</span><span class="token string">&quot;xpx&quot;</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{</span>pt<span class="token punctuation">[</span><span class="token string">&quot;ypx&quot;</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{</span>pt<span class="token punctuation">[</span><span class="token string">&quot;transx&quot;</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{</span>pt<span class="token punctuation">[</span><span class="token string">&quot;transy&quot;</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">&#39;</span></span>
    gdaltranslate_cmdline <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f&quot;</span><span class="token interpolation"><span class="token punctuation">{</span>gdaltranslate_cmdline<span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>abspath<span class="token punctuation">(</span>tif<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f&#39;tmp.</span><span class="token interpolation"><span class="token punctuation">{</span>filename<span class="token punctuation">}</span></span><span class="token string">&#39;</span></span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="how-to-using-gcp-to-warp-file" tabindex="-1"><a class="header-anchor" href="#how-to-using-gcp-to-warp-file" aria-hidden="true">#</a> How to using gcp to warp file</h2><p>using the gdal tool gdalwarp to warp geotif</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code>gdalwarp_cmdline <span class="token operator">=</span> <span class="token string">&#39;gdalwarp -r bilinear -order 3 -co COMPRESS=NONE  -t_srs EPSG:4326 &#39;</span>
gdalwarp_cmdline <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f&quot;</span><span class="token interpolation"><span class="token punctuation">{</span>gdalwarp_cmdline<span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f&#39;tmp.</span><span class="token interpolation"><span class="token punctuation">{</span>filename<span class="token punctuation">}</span></span><span class="token string">&#39;</span></span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f&#39;tmp.warp.</span><span class="token interpolation"><span class="token punctuation">{</span>filename<span class="token punctuation">}</span></span><span class="token string">&#39;</span></span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="the-final-result" tabindex="-1"><a class="header-anchor" href="#the-final-result" aria-hidden="true">#</a> The final result</h2><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token keyword">from</span> osgeo <span class="token keyword">import</span> gdal
<span class="token keyword">import</span> requests <span class="token keyword">as</span> req
<span class="token keyword">import</span> json
<span class="token keyword">import</span> os

<span class="token comment"># 横向采样点数量（不采集边缘点）</span>
x_pt_count <span class="token operator">=</span> <span class="token number">10</span>

<span class="token comment"># 纵向采样点数量（不采集边缘点）</span>
y_pt_count <span class="token operator">=</span> <span class="token number">10</span>

url <span class="token operator">=</span> <span class="token string">&#39;http://192.168.31.194:8081/encrypt/m2&#39;</span>

tif_file <span class="token operator">=</span> <span class="token string">&#39;historymap.tif&#39;</span>

<span class="token comment">#</span>
<span class="token comment"># @desc 使用加密服务对数据进行加密</span>
<span class="token comment"># @param tif  待加密文件</span>
<span class="token comment"># @param xpt_count 横向采样点数量</span>
<span class="token comment"># @param ypt_count 纵向采样点数量</span>
<span class="token comment"># @param m2_url    加密服务地址</span>
<span class="token keyword">def</span> <span class="token function">m2encrypt</span><span class="token punctuation">(</span>tif<span class="token punctuation">,</span> xpt_count<span class="token punctuation">,</span> ypt_count<span class="token punctuation">,</span> m2_url<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 读取文件</span>
    dataset <span class="token operator">=</span> gdal<span class="token punctuation">.</span>Open<span class="token punctuation">(</span>tif<span class="token punctuation">)</span>
    
    <span class="token comment"># 获取Transform</span>
    geotransform <span class="token operator">=</span> dataset<span class="token punctuation">.</span>GetGeoTransform<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 获取采样间隔</span>
    x_offset <span class="token operator">=</span> dataset<span class="token punctuation">.</span>RasterXSize <span class="token operator">/</span> <span class="token punctuation">(</span>xpt_count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
    y_offset <span class="token operator">=</span> dataset<span class="token punctuation">.</span>RasterYSize <span class="token operator">/</span> <span class="token punctuation">(</span>ypt_count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 关闭数据</span>
    dataset <span class="token operator">=</span> <span class="token boolean">None</span>
    
    <span class="token comment"># 构建加密请求参数</span>
    idx <span class="token operator">=</span> <span class="token number">1</span>
    pts <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;algorithm&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;m2&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;msg&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;pts&quot;</span><span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> xpt_count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> y <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> ypt_count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            idx <span class="token operator">+=</span> <span class="token number">1</span>
            pts<span class="token punctuation">[</span><span class="token string">&quot;pts&quot;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{</span>
                <span class="token string">&quot;id&quot;</span>  <span class="token punctuation">:</span> idx<span class="token punctuation">,</span>
                <span class="token string">&quot;xpx&quot;</span> <span class="token punctuation">:</span> x_offset <span class="token operator">*</span> x<span class="token punctuation">,</span>
                <span class="token string">&quot;ypx&quot;</span> <span class="token punctuation">:</span> y_offset <span class="token operator">*</span> y<span class="token punctuation">,</span>
                <span class="token string">&quot;orgx&quot;</span><span class="token punctuation">:</span> geotransform<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token operator">+</span> geotransform<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> x_offset <span class="token operator">*</span> x<span class="token punctuation">,</span>
                <span class="token string">&quot;orgy&quot;</span><span class="token punctuation">:</span> geotransform<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>  <span class="token operator">+</span> geotransform<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">*</span> y_offset <span class="token operator">*</span> y<span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 加密请求</span>
    resp <span class="token operator">=</span> req<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">&#39;pts_info&#39;</span><span class="token punctuation">:</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>pts<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 获取加密结果</span>
    ret <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>resp<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
    
    <span class="token comment"># 构建处理脚本对文件本身进行加密</span>
    gdaltranslate_cmdline <span class="token operator">=</span> <span class="token string">&#39;gdal_translate -of GTiff&#39;</span>
    gdalwarp_cmdline <span class="token operator">=</span> <span class="token string">&#39;gdalwarp -r bilinear -order 3 -co COMPRESS=NONE  -t_srs EPSG:4326 &#39;</span>

    <span class="token keyword">if</span> ret<span class="token punctuation">[</span><span class="token string">&#39;ret&#39;</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> pt <span class="token keyword">in</span> ret<span class="token punctuation">[</span><span class="token string">&#39;pts&#39;</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            gdaltranslate_cmdline <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f&#39;</span><span class="token interpolation"><span class="token punctuation">{</span>gdaltranslate_cmdline<span class="token punctuation">}</span></span><span class="token string"> -gcp </span><span class="token interpolation"><span class="token punctuation">{</span>pt<span class="token punctuation">[</span><span class="token string">&quot;xpx&quot;</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{</span>pt<span class="token punctuation">[</span><span class="token string">&quot;ypx&quot;</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{</span>pt<span class="token punctuation">[</span><span class="token string">&quot;transx&quot;</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{</span>pt<span class="token punctuation">[</span><span class="token string">&quot;transy&quot;</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">&#39;</span></span>
    path<span class="token punctuation">,</span> filename <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>split<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>abspath<span class="token punctuation">(</span>tif<span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    
    gdaltranslate_cmdline <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f&quot;</span><span class="token interpolation"><span class="token punctuation">{</span>gdaltranslate_cmdline<span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>abspath<span class="token punctuation">(</span>tif<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f&#39;tmp.</span><span class="token interpolation"><span class="token punctuation">{</span>filename<span class="token punctuation">}</span></span><span class="token string">&#39;</span></span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span>
    gdalwarp_cmdline <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f&quot;</span><span class="token interpolation"><span class="token punctuation">{</span>gdalwarp_cmdline<span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f&#39;tmp.</span><span class="token interpolation"><span class="token punctuation">{</span>filename<span class="token punctuation">}</span></span><span class="token string">&#39;</span></span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f&#39;tmp.warp.</span><span class="token interpolation"><span class="token punctuation">{</span>filename<span class="token punctuation">}</span></span><span class="token string">&#39;</span></span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span>
    
    <span class="token keyword">return</span> gdaltranslate_cmdline<span class="token punctuation">,</span> gdalwarp_cmdline
    
cmdlines <span class="token operator">=</span> m2encrypt<span class="token punctuation">(</span>tif_file<span class="token punctuation">,</span> x_pt_count<span class="token punctuation">,</span> y_pt_count<span class="token punctuation">,</span> url<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>cmdlines<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>cmdlines<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,14),e=[o];function c(i,l){return s(),a("div",null,e)}const k=n(p,[["render",c],["__file","gcptowarp.html.vue"]]);export{k as default};
